generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BreakerType {
  STANDARD
  GFCI
  AFCI
  DUAL_FUNCTION
}

enum NodeKind {
  OUTLET
  OUTLET_240
  SWITCH
  DIMMER
  LIGHT
  FAN
  APPLIANCE
  COOKTOP
  DRYER
  AC
  PANEL_FEED
  OTHER
}

enum NodeLinkKind {
  GFCI_PROTECTS
  SWITCH_CONTROLS
  FEEDS
  OTHER
}

model Floor {
  id          String   @id @default(cuid())
  name        String
  level       Int?
  description String?
  rooms       Room[]
  nodes       Node[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Room {
  id        String   @id @default(cuid())
  name      String
  floorId   String
  floor     Floor    @relation(fields: [floorId], references: [id], onDelete: Cascade)
  nodes     Node[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NodeType {
  id        String   @id @default(cuid())
  key       String   @unique
  label     String
  icon      String?
  kind      NodeKind
  nodes     Node[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Panel {
  id              String    @id @default(cuid())
  name            String
  location        String?
  rows            Int?
  columns         Int?
  parentPanelId   String?
  parentPanel     Panel?    @relation("PanelHierarchy", fields: [parentPanelId], references: [id])
  subpanels       Panel[]   @relation("PanelHierarchy")
  supplyBreakerId String?   @unique
  supplyBreaker   Breaker?  @relation("PanelSupply", fields: [supplyBreakerId], references: [id])
  circuits        Circuit[]
  breakers        Breaker[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Circuit {
  id        String    @id @default(cuid())
  name      String?
  label     String?
  amperage  Int?
  voltage   Int?
  color     String?
  notes     String?
  panelId   String?
  panel     Panel?    @relation(fields: [panelId], references: [id], onDelete: SetNull)
  breakers  Breaker[]
  nodes     Node[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Breaker {
  id         String      @id @default(cuid())
  panelId    String
  panel      Panel       @relation(fields: [panelId], references: [id], onDelete: Cascade)
  slotNumber Int?
  label      String?
  poleCount  Int?
  type       BreakerType @default(STANDARD)
  amperage   Int?
  voltage    Int?
  circuitId  String?
  circuit    Circuit?    @relation(fields: [circuitId], references: [id], onDelete: SetNull)
  feedsPanel Panel?      @relation("PanelSupply")
  linksA     BreakerLink[] @relation("BreakerLinkA")
  linksB     BreakerLink[] @relation("BreakerLinkB")
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@unique([panelId, slotNumber], map: "panel_slot_unique")
}

model BreakerLink {
  id          String   @id @default(cuid())
  breakerAId  String
  breakerBId  String
  kind        String?  // e.g., TIED, SHARED_HANDLE
  breakerA    Breaker  @relation("BreakerLinkA", fields: [breakerAId], references: [id], onDelete: Cascade)
  breakerB    Breaker  @relation("BreakerLinkB", fields: [breakerBId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([breakerAId, breakerBId], map: "breaker_link_pair_unique")
}

model Node {
  id           String    @id @default(cuid())
  name         String?
  description  String?
  floorId      String
  floor        Floor     @relation(fields: [floorId], references: [id], onDelete: Cascade)
  roomId       String?
  room         Room?     @relation(fields: [roomId], references: [id], onDelete: SetNull)
  typeId       String?
  type         NodeType? @relation(fields: [typeId], references: [id], onDelete: SetNull)
  kind         NodeKind  @default(OUTLET)
  x            Float
  y            Float
  rotation     Float?
  circuitId    String?
  circuit      Circuit?  @relation(fields: [circuitId], references: [id], onDelete: SetNull)
  isGfci       Boolean   @default(false)
  notes        String?
  linksFrom    NodeLink[] @relation("NodeLinkFrom")
  linksTo      NodeLink[] @relation("NodeLinkTo")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model NodeLink {
  id        String       @id @default(cuid())
  kind      NodeLinkKind
  fromId    String
  toId      String
  from      Node         @relation("NodeLinkFrom", fields: [fromId], references: [id], onDelete: Cascade)
  to        Node         @relation("NodeLinkTo", fields: [toId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([fromId])
  @@index([toId])
  @@index([kind])
}

